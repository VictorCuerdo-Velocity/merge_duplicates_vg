<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Contact Merge Report - {{ timestamp }}</title>
  <style>
    body { font-family: monospace; margin: 20px; }
    h1 { color: #333; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    .success { color: green; }
    .failure { color: red; }
    .record-number { color: #E91E63; font-weight: bold; font-size: 1.4em; }
    .ref-1 { color: #2196F3; }
    .ref-2 { color: #FF9800; }
    /* Colors for specific log lines */
    .found { color: green; font-size: 1.4em;font-weight: bold; }
    .primary-log { color: green; }
    .duplicate-log { color: red; }
    pre {
      background: #f8f8f8;
      padding: 10px;
      border: 1px solid #ccc;
      overflow-x: auto;
      white-space: pre;
      margin: 0;
      font-size: 0.95em;
    }
    .log-line { display: inline; }
  </style>
</head>
<body>
  <h1>Contact Merge Report</h1>
  <p><strong>Date:</strong> {{ timestamp }}</p>

  <h2>Summary</h2>
  <ul>
    <li>Total Merges Attempted: {{ summary.total_merges_attempted }}</li>
    <li class="success">Successful Merges: {{ summary.successful_merges }}</li>
    <li class="failure">Failed Merges: {{ summary.failed_merges }}</li>
  </ul>

  <h2>Successful Merges</h2>
  {%- if successful_merges %}
    <table>
      <thead>
        <tr>
          <th>Primary Name</th>
          <th>Primary Email</th>
          <th>Duplicate Name</th>
          <th>Duplicate Email</th>
          <th>Original Ticket Count</th>
          <th>Final Ticket Count</th>
        </tr>
      </thead>
      <tbody>
        {%- for merge in successful_merges %}
        <tr>
          <td>{{ merge.primary.display_name }}</td>
          <td>{{ merge.primary.email }}</td>
          <td>{{ merge.duplicate.display_name }}</td>
          <td>{{ merge.duplicate.email }}</td>
          <td>{{ merge.primary.original_ticket_count }}</td>
          <td>{{ merge.primary.final_ticket_count }}</td>
        </tr>
        {%- endfor %}
      </tbody>
    </table>
  {%- else %}
    <p>No successful merges.</p>
  {%- endif %}

  <h2>Failed Merges</h2>
  {%- if failed_merges %}
    <table>
      <thead>
        <tr>
          <th>Primary Name</th>
          <th>Primary Email</th>
          <th>Duplicate Name</th>
          <th>Duplicate Email</th>
          <th>Error</th>
        </tr>
      </thead>
      <tbody>
        {%- for failure in failed_merges %}
        <tr>
          <td>{{ failure.primary.display_name }}</td>
          <td>{{ failure.primary.email }}</td>
          <td>{{ failure.duplicate.display_name }}</td>
          <td>{{ failure.duplicate.email }}</td>
          <td>{{ failure.error }}</td>
        </tr>
        {%- endfor %}
      </tbody>
    </table>
  {%- else %}
    <p>No failed merges.</p>
  {%- endif %}

  <h2>Log Details</h2>
  <pre>{%- for line in log_content.split('\n') -%}
{%- set trimmed = line.strip() -%}
{%- if trimmed -%}
  {%- if trimmed[0:6] == "Found " and "duplicate pairs to process" in trimmed -%}
    <span class="log-line found">{{ trimmed }}</span>
  {%- elif "Primary:" in trimmed -%}
    <span class="log-line primary-log">{{ trimmed }}</span>
  {%- elif "Duplicate:" in trimmed -%}
    <span class="log-line duplicate-log">{{ trimmed }}</span>
  {%- elif "record(s)" in trimmed -%}
    {%- set parts = trimmed.split(' has ') -%}
    {%- set number = parts[1].split(' ')[0] -%}
    <span class="log-line">{{ parts[0] }} has <span class="record-number">{{ number }}</span> record(s)</span>
  {%- elif "External references:" in trimmed -%}
    {%- set parts = trimmed.split('External references: [') -%}
    {%- set refs = parts[1].replace("']", "").split("', '") -%}
    <span class="log-line">{{ parts[0] }}External references: [<span class="ref-1">'{{ refs[0] }}'</span>{% if refs|length > 1 %}, <span class="ref-2">'{{ refs[1] }}'</span>{% endif %}]</span>
  {%- else -%}
    <span class="log-line">{{ trimmed }}</span>
  {%- endif -%}
  {%- if not loop.last -%}{{ "\n" }}{%- endif -%}
{%- endif -%}
{%- endfor %}</pre>
</body>
</html>
